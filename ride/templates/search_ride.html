{% extends "base.html" %}
{% load static %}

{% block content %}
<h1></h1>
<div class="container justify-content-center align-items-center vh-100">
  <div class="row">
    <h1 class="text-center mt-5">BUSCAR CARONA</h1>
  </div>
  <hr class="my-5">
  <div class="row">
    <div class="col-12">
      <div class="card shadow" style="border-radius: 15px; width: 40%; margin: auto;">
        <div class="card-body text-center">
          <form id="search-ride-form">
            {% csrf_token %}
            <div class="mb-4 input-group">
              <label for="starting_point" class="form-label w-100 text-start">Local de Partida:</label>
              <input type="text" class="form-control" id="starting_point" name="starting_point" required>
              <input type="hidden" id="starting_point_coords" name="starting_point_coords">
              <button type="button" class="btn btn-outline-secondary" id="starting_point_map_btn">
                <i class="fas fa-map-marker-alt"></i>
              </button>
            </div>
            <div class="mb-4 input-group">
              <label for="destination" class="form-label w-100 text-start">Destino:</label>
              <input type="text" class="form-control" id="destination" name="destination" required>
              <input type="hidden" id="destination_coords" name="destination_coords">
              <button type="button" class="btn btn-outline-secondary" id="destination_map_btn">
                <i class="fas fa-map-marker-alt"></i>
              </button>
            </div>
            <div class="mb-4">
              <label for="starting_hour" class="form-label">Data e Hora:</label>
              <input type="datetime-local" class="form-control" id="starting_hour" name="starting_hour" required>
            </div>
            <div class="mb-4">
              <label for="passengers" class="form-label">Quantidade de Passageiros:</label>
              <input type="number" class="form-control" id="passengers" name="passengers" required>
            </div>
            <button type="submit" class="btn btn-outline-primary btn-rounded btn-lg">Buscar</button>
          </form>
          <div id="results" class="mt-4"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById('search-ride-form').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const startingPoint = document.getElementById('starting_point').value;
    const startingPointCoords = document.getElementById('starting_point_coords').value;
    const destination = document.getElementById('destination').value;
    const destinationCoords = document.getElementById('destination_coords').value;
    const startingHour = document.getElementById('starting_hour').value;
    const passengers = document.getElementById('passengers').value;
  
    const data = {
      csrfmiddlewaretoken: csrftoken,
      starting_point: startingPoint,
      starting_point_coords: startingPointCoords,
      destination: destination,
      destination_coords: destinationCoords,
      starting_hour: startingHour,
      passengers: passengers
    };

    console.log("Enviando dados:", data);
  
    fetch("{% url 'ride:search_ride' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (!response.ok) {
        return response.text().then(text => { throw new Error(text) })
      }
      return response.json()
    })
    .then(data => {
      console.log('Success:', data);

      if (data.rides) {
        let resultsHTML = '<h3>Rides Disponíveis:</h3><ul>';
        data.rides.forEach(ride => {
          resultsHTML += `
            <li>
              Car: ${ride.car}<br>
              Horário: ${ride.starting_hour}<br>
              Assentos Disponíveis: ${ride.available_seats}<br>
              Partida: ${ride.starting_point}<br>
              Destino: ${ride.destination}<br>
            </li>
          `;
        });
        resultsHTML += '</ul>';
        document.getElementById("results").innerHTML = resultsHTML;
      } else {
        document.getElementById("results").innerHTML = `<p>${data.message}</p>`;
      }
    })
    .catch((error) => {
      console.error('Error:', error);
      alert("Ocorreu um erro: " + error.message);
    });
  });

  function initAutocomplete() {
    const inputStart = document.getElementById("starting_point");
    const inputEnd = document.getElementById("destination");

    const autocompleteStart = new google.maps.places.Autocomplete(inputStart);
    const autocompleteEnd = new google.maps.places.Autocomplete(inputEnd);

    autocompleteStart.addListener('place_changed', function() {
      const place = autocompleteStart.getPlace();
      if (!place.geometry) {
        alert("No details available for input: '" + place.name + "'");
        return;
      }
      const location = place.geometry.location;
      document.getElementById('starting_point_coords').value = `${location.lat()}, ${location.lng()}`;
    });

    autocompleteEnd.addListener('place_changed', function() {
      const place = autocompleteEnd.getPlace();
      if (!place.geometry) {
        alert("No details available for input: '" + place.name + "'");
        return;
      }
      const location = place.geometry.location;
      document.getElementById('destination_coords').value = `${location.lat()}, ${location.lng()}`;
    });
  }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD7tOzctlkLRIJdLBUuFbbPy5YoKoB0jjA&libraries=places&callback=initAutocomplete"></script>
{% endblock %}
